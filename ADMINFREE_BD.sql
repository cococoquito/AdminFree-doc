/*  
 ***************** CREACION ESQUEMA ADMINFREE *******************************
 */ 
CREATE SCHEMA ADMINFREE DEFAULT CHARACTER SET utf8 COLLATE utf8_spanish_ci ;


/* 
 ***************** CREACION DE LAS TABLAS ****************************************
 */ 
CREATE TABLE ADMINFREE.CLIENTES (
  ID_CLIENTE 				  TINYINT	         	NOT NULL AUTO_INCREMENT,
  TOKEN 					      VARCHAR(50)  	NOT NULL,
  NOMBRE 					  VARCHAR(100)	NOT NULL,
  USUARIO 					  VARCHAR(100)	NOT NULL,
  TELEFONOS 				  VARCHAR(50)	 	NULL,
  EMAILS 					      VARCHAR(100)	NULL,
  FECHA_ACTIVACION 	  DATE 		     	NOT NULL,
  FECHA_INACTIVACION DATE 		     	NULL,
  ESTADO 					  TINYINT 	     	NOT NULL,
  PRIMARY KEY (ID_CLIENTE)
);

CREATE TABLE ADMINFREE.USUARIOS (
  ID_USUARIO 				INTEGER			NOT NULL AUTO_INCREMENT,
  NOMBRE 					VARCHAR(100) NOT NULL,
  USUARIO_INGRESO 	VARCHAR(50) 	NOT NULL,
  CLAVE_INGRESO 		VARCHAR(50) 	NOT NULL,
  CLIENTE  					TINYINT	        NOT NULL,
  ESTADO 					TINYINT			NOT NULL,
  PRIMARY KEY (ID_USUARIO),
  FOREIGN KEY(CLIENTE) REFERENCES ADMINFREE.CLIENTES(ID_CLIENTE)
);

CREATE TABLE ADMINFREE.ROLES (
  ID_ROL		TINYINT			NOT NULL,
  NOMBRE 	VARCHAR(50)	NOT NULL,
  PRIMARY KEY (ID_ROL)
);

CREATE TABLE ADMINFREE.USUARIOS_ROLES (
  ID_USUARIO 	INTEGER	NOT NULL,
  ID_ROL			TINYINT	NOT NULL,
  FOREIGN KEY(ID_USUARIO) REFERENCES ADMINFREE.USUARIOS(ID_USUARIO),
  FOREIGN KEY(ID_ROL) REFERENCES ADMINFREE.ROLES(ID_ROL)
);


/* 
 *****************CREACION DE PROCEDIMIENTOS ALMACENADOS****************************
 */ 
DELIMITER //
	CREATE PROCEDURE ADMINFREE.PR_ELIMINAR_CLIENTE(IN ID TINYINT,  OUT RESPUESTA VARCHAR(700))
	BEGIN

		/*Manejo de errores*/ 
		DECLARE EXIT HANDLER FOR SQLEXCEPTION
		BEGIN
			ROLLBACK;
			GET STACKED DIAGNOSTICS CONDITION 1 RESPUESTA = MESSAGE_TEXT;
		END;
		
		/*Inicia transaccion*/ 
		START TRANSACTION; 
		
			/*Se elimina los roles relacionados a todos los usuarios relacionados al cliente*/ 
			DELETE FROM ADMINFREE.USUARIOS_ROLES WHERE ID_USUARIO IN (SELECT ID_USUARIO FROM ADMINFREE.USUARIOS WHERE CLIENTE = ID);
			
			/*Se elimina todos los usuarios relacionados al cliente*/ 
			DELETE FROM ADMINFREE.USUARIOS WHERE CLIENTE = ID;
		
			/*Se elimina el cliente*/ 
			DELETE FROM ADMINFREE.CLIENTES WHERE ID_CLIENTE = ID;		
		
		/*Fin de transaccion */ 
		COMMIT; 
		
		/*Mandamos OK si todo salio bien*/ 
		SET RESPUESTA = 'OK';
	END //
DELIMITER ;


/* 
 ****************************************INSERTS INICIALES***************************************************
 */ 
INSERT INTO ADMINFREE.ROLES (ID_ROL, NOMBRE)  VALUES  (1, ' Correspondencia' );
INSERT INTO ADMINFREE.ROLES (ID_ROL, NOMBRE)  VALUES  (2, ' Archivo de Gesti√≥n' );
