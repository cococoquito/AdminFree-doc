/*  
 ***************** CREACION ESQUEMA ADMINFREE *******************************
 */ 
CREATE SCHEMA ADMINFREE DEFAULT CHARACTER SET utf8 COLLATE utf8_spanish_ci ;


/* 
 ***************** CREACION DE LAS TABLAS ****************************************
 */ 
CREATE TABLE ADMINFREE.CLIENTES (
  ID_CLIENTE 				  TINYINT	         	NOT NULL AUTO_INCREMENT,
  TOKEN 					      VARCHAR(50)  	NOT NULL,
  NOMBRE 					  VARCHAR(100)	NOT NULL,
  USUARIO 					  VARCHAR(100)	NOT NULL,
  TELEFONOS 				  VARCHAR(50)	 	NULL,
  EMAILS 					      VARCHAR(100)	NULL,
  FECHA_ACTIVACION 	  DATE 		     	NOT NULL,
  FECHA_INACTIVACION DATE 		     	NULL,
  ESTADO 					  TINYINT 	     	NOT NULL,
  PRIMARY KEY (ID_CLIENTE)
);

CREATE TABLE ADMINFREE.USUARIOS (
  ID_USUARIO 				INTEGER			NOT NULL AUTO_INCREMENT,
  NOMBRE 					VARCHAR(100) NOT NULL,
  USUARIO_INGRESO 	VARCHAR(50) 	NOT NULL,
  CLAVE_INGRESO 		VARCHAR(50) 	NOT NULL,
  CLIENTE  					TINYINT	        NOT NULL,
  ESTADO 					TINYINT			NOT NULL,
  PRIMARY KEY (ID_USUARIO),
  FOREIGN KEY(CLIENTE) REFERENCES ADMINFREE.CLIENTES(ID_CLIENTE)
);

CREATE TABLE ADMINFREE.MODULOS (
  TOKEN_MODULO VARCHAR(50)	NOT NULL,
  NOMBRE 	  		  VARCHAR(50)	NOT NULL,
  PRIMARY KEY (TOKEN_MODULO)
);

CREATE TABLE ADMINFREE.USUARIOS_MODULOS (
  ID_USUARIO 		  INTEGER		NOT NULL,
  TOKEN_MODULO VARCHAR(50)	NOT NULL,
  FOREIGN KEY(ID_USUARIO) REFERENCES ADMINFREE.USUARIOS(ID_USUARIO),
  FOREIGN KEY(TOKEN_MODULO)  REFERENCES ADMINFREE.MODULOS(TOKEN_MODULO)
);

CREATE TABLE ADMINFREE.RESTRICCIONES (
	ID_RESTRICCION  TINYINT			NOT NULL,
	NOMBRE 			 	VARCHAR(100)	NOT NULL,
	DESCRIPCION 	 	VARCHAR(255)	NOT NULL,
	PRIMARY KEY (ID_RESTRICCION)
);

CREATE TABLE ADMINFREE.RESTRICCIONES_TIPO_CAMPO (
	RESTRICCION 	TINYINT	NOT NULL,
	TIPO_CAMPO 	TINYINT   NOT NULL,
	PRIMARY KEY (RESTRICCION, TIPO_CAMPO),
	FOREIGN KEY (RESTRICCION) REFERENCES ADMINFREE.RESTRICCIONES(ID_RESTRICCION)
);

CREATE TABLE ADMINFREE.CAMPOS_ENTRADA (
	ID_CAMPO  	  	INTEGER			NOT NULL AUTO_INCREMENT,
	CLIENTE 	  		TINYINT			NOT NULL,
	TIPO_CAMPO 	TINYINT 			NOT NULL,
	NOMBRE 			VARCHAR(100)	NOT NULL,
	DESCRIPCION 	VARCHAR(255),
	PRIMARY KEY (ID_CAMPO),
	FOREIGN KEY (CLIENTE) REFERENCES ADMINFREE.CLIENTES(ID_CLIENTE)
);

CREATE TABLE ADMINFREE.CAMPOS_ENTRADA_RESTRICCIONES (
	CAMPO			 INTEGER	NOT NULL,
	RESTRICCION 	 TINYINT	NOT NULL,
	PRIMARY KEY (CAMPO, RESTRICCION),
	FOREIGN KEY (CAMPO) REFERENCES ADMINFREE.CAMPOS_ENTRADA(ID_CAMPO),
	FOREIGN KEY (RESTRICCION) REFERENCES ADMINFREE.RESTRICCIONES(ID_RESTRICCION)
);

CREATE TABLE ADMINFREE.SELECT_ITEMS (
	ID_ITEM		INTEGER			NOT NULL AUTO_INCREMENT,
	CAMPO		INTEGER			NOT NULL,
	VALOR			VARCHAR(255) NOT NULL,
	PRIMARY KEY (ID_ITEM),
	FOREIGN KEY (CAMPO) REFERENCES ADMINFREE.CAMPOS_ENTRADA(ID_CAMPO)
);

CREATE TABLE ADMINFREE.NOMENCLATURAS (
	ID_NOMENCLATURA INTEGER			NOT NULL AUTO_INCREMENT,
	CLIENTE 	  				TINYINT			NOT NULL,
	NOMBRE 					VARCHAR(50)	NOT NULL,
	DESCRIPCION 			VARCHAR(255)	NOT NULL,
	ESTADO 					TINYINT			NOT NULL,
	PRIMARY KEY (ID_NOMENCLATURA),
	FOREIGN KEY (CLIENTE) REFERENCES ADMINFREE.CLIENTES(ID_CLIENTE)
);

CREATE TABLE ADMINFREE.NOMENCLATURAS_CAMPOS_ENTRADA (
	NOMENCLATURA  	INTEGER NOT NULL,
	CAMPO 					INTEGER NOT NULL,
	PRIMARY KEY (NOMENCLATURA, CAMPO),
	FOREIGN KEY (NOMENCLATURA) REFERENCES ADMINFREE.NOMENCLATURAS(ID_NOMENCLATURA),
	FOREIGN KEY (CAMPO) REFERENCES ADMINFREE.CAMPOS_ENTRADA(ID_CAMPO)
);

/*
 *****************CREACION DE PROCEDIMIENTOS ALMACENADOS****************************
 */ 
DELIMITER //
	CREATE PROCEDURE ADMINFREE.PR_ELIMINAR_CLIENTE(IN ID TINYINT,  OUT RESPUESTA VARCHAR(700))
	BEGIN

		/*Manejo de errores*/ 
		DECLARE EXIT HANDLER FOR SQLEXCEPTION
		BEGIN
			ROLLBACK;
			GET STACKED DIAGNOSTICS CONDITION 1 RESPUESTA = MESSAGE_TEXT;
		END;
		
		/*Inicia transaccion*/ 
		START TRANSACTION; 
		
			/*Se elimina los modulos relacionados a todos los usuarios relacionados al cliente*/ 
			DELETE FROM ADMINFREE.USUARIOS_MODULOS WHERE ID_USUARIO IN (SELECT ID_USUARIO FROM ADMINFREE.USUARIOS WHERE CLIENTE = ID);
			
			/*Se elimina todos los usuarios relacionados al cliente*/ 
			DELETE FROM ADMINFREE.USUARIOS WHERE CLIENTE = ID;
		
			/*Se elimina el cliente*/ 
			DELETE FROM ADMINFREE.CLIENTES WHERE ID_CLIENTE = ID;		
		
		/*Fin de transaccion */ 
		COMMIT; 
		
		/*Mandamos OK si todo salio bien*/ 
		SET RESPUESTA = 'OK';
	END //
DELIMITER ;


/* 
 ****************************************INSERTS INICIALES***************************************************
 */ 
INSERT INTO ADMINFREE.MODULOS (TOKEN_MODULO, NOMBRE)  VALUES  ('9f1124f946de506332f221a01d39c411', ' Correspondencia' );
INSERT INTO ADMINFREE.MODULOS (TOKEN_MODULO, NOMBRE)  VALUES  ('a9ee4d222a05960a00ea9b5eb6fb0a81', ' Archivo de Gestión' );
INSERT INTO ADMINFREE.MODULOS (TOKEN_MODULO, NOMBRE)  VALUES  ('b6177afc6e3818cb7cb663cf71ef1ce4', ' Reportes' );
INSERT INTO ADMINFREE.MODULOS (TOKEN_MODULO, NOMBRE)  VALUES  ('4813e117da87e1ae5bdfb0d4967f4387', ' Configuraciones' );

INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (1, 'Campo Opcional', 'El valor del campo es <strong>opcional</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (2, 'Campo Obligatorio', 'El valor del campo es <strong>obligatorio</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (3, 'Valor del campo numérico', 'El valor del campo debe ser <strong>solo números</strong>' );
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (4, 'Valor del campo único para la nomenclatura asociada', 'El valor del campo debe ser único <strong>solamente para la nomenclatura asociada al campo</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (5, 'Valor del campo único para todas las nomenclaturas asociadas', 'El valor del campo debe ser único para <strong>todas las nomenclaturas asociadas al campo</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (6, 'Fecha debe ser igual a la fecha actual' , 'El valor de la fecha será la fecha actual y el <strong>usuario NO podrá modificar este valor</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (7, 'Fecha debe iniciar con la fecha actual', 'El valor por defecto de la fecha será la fecha actual y el <strong>usuario SI podrá modificar este valor</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (8, 'Fecha debe ser mayor a la fecha actual', 'El valor de la fecha debe ser <strong>mayor a la fecha actual</strong>');
INSERT INTO ADMINFREE.RESTRICCIONES (ID_RESTRICCION, NOMBRE, DESCRIPCION) VALUES (9, 'Fecha debe ser menor a la fecha actual', 'El valor de la fecha debe ser <strong>menor a la fecha actual</strong>');

INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (1, 1);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (1, 2);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (1, 3);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (1, 4);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (2, 1);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (2, 2);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (2, 3);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (2, 4);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (3, 1);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (4, 1);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (5, 1);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (6, 4);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (7, 4);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (8, 4);
INSERT INTO ADMINFREE.RESTRICCIONES_TIPO_CAMPO(RESTRICCION, TIPO_CAMPO) VALUES (9, 4);


